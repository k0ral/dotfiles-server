# {{{ Variables
server.tag              = ""
server.port             = 7443
server.username         = "http"
server.groupname        = "http"
server.document-root	= "/srv/http"
server.pid-file         = "/var/run/lighttpd/lighttpd.pid"
server.errorlog         = "/var/log/lighttpd/error.log"
dir-listing.activate	= "disable"
index-file.names        = ( "index.html", "index.php", "dispatch.fcgi" )
accesslog.filename      = "/var/log/lighttpd/twyk.org.log"
# }}}

# {{{ Mimetypes
mimetype.assign	= (
    ".pdf"          =>  "application/pdf",
    ".sig"          =>  "application/pgp-signature",
    ".spl"          =>  "application/futuresplash",
    ".class"        =>  "application/octet-stream",
    ".ps"           =>  "application/postscript",
    ".torrent"      =>  "application/x-bittorrent",
    ".dvi"          =>  "application/x-dvi",
    ".gz"           =>  "application/x-gzip",
    ".pac"          =>  "application/x-ns-proxy-autoconfig",
    ".swf"          =>  "application/x-shockwave-flash",
    ".tar.gz"       =>  "application/x-tgz",
    ".tgz"          =>  "application/x-tgz",
    ".tar"          =>  "application/x-tar",
    ".zip"          =>  "application/zip",
    ".mp3"          =>  "audio/mpeg",
    ".m3u"          =>  "audio/x-mpegurl",
    ".wma"          =>  "audio/x-ms-wma",
    ".wax"          =>  "audio/x-ms-wax",
    ".ogg"          =>  "application/ogg",
    ".wav"          =>  "audio/x-wav",
    ".gif"          =>  "image/gif",
    ".jpg"          =>  "image/jpeg",
    ".jpeg"         =>  "image/jpeg",
    ".png"          =>  "image/png",
    ".xbm"          =>  "image/x-xbitmap",
    ".xpm"          =>  "image/x-xpixmap",
    ".xwd"          =>  "image/x-xwindowdump",
    ".css"          =>  "text/css",
    ".html"         =>  "text/html",
    ".htm"          =>  "text/html",
    ".js"           =>  "text/javascript",
    ".asc"          =>  "text/plain; charset=utf8",
    ".c"            =>  "text/plain; charset=utf8",
    ".cpp"          =>  "text/plain; charset=utf8",
    ".log"          =>  "text/plain; charset=utf8",
    ".conf"         =>  "text/plain; charset=utf8",
    ".text"         =>  "text/plain; charset=utf8",
    ".txt"          =>  "text/plain; charset=utf8",
    ".dtd"          =>  "text/xml",
    ".xml"          =>  "text/xml",
    ".mpeg"         =>  "video/mpeg",
    ".mpg"          =>  "video/mpeg",
    ".mov"          =>  "video/quicktime",
    ".qt"           =>  "video/quicktime",
    ".avi"          =>  "video/x-msvideo",
    ".asf"          =>  "video/x-ms-asf",
    ".asx"          =>  "video/x-ms-asf",
    ".wmv"          =>  "video/x-ms-wmv",
    ".bz2"          =>  "application/x-bzip",
    ".tbz"          =>  "application/x-bzip-compressed-tar",
    ".tar.bz2"      =>  "application/x-bzip-compressed-tar"
)
# }}}

# {{{ Modules
server.modules = (
    "mod_access",
    "mod_alias",
    "mod_auth",
    "mod_cgi",
    "mod_expire",
    "mod_fastcgi",
    "mod_accesslog",
    "mod_setenv",
    "mod_redirect",
    "mod_rewrite",
    "mod_proxy",
    "mod_scgi",
#   "mod_evasive",
#   "mod_cml",
#   "mod_trigger_b4_dl",
#   "mod_status",
#   "mod_simple_vhost",
#   "mod_evhost",
#   "mod_userdir",
#   "mod_compress",
#   "mod_ssi",
#   "mod_usertrack",
#   "mod_secdownload",
#   "mod_rrdtool",
)
# }}}

# {{{ Mod Evasive
#evasive.max-conns-per-ip = 20
# }}}

# {{{ FastCGI
server.error-handler-404   = "/dispatch.fcgi" #too
fastcgi.debug = 1
fastcgi.map-extensions = ( ".php3" => ".php", ".php4" => ".php" )
fastcgi.server = (
    ".php" => ("localhost" => (
        "socket" => "/tmp/php-fastcgi.socket",
        "bin-path" => "/usr/bin/php-cgi"
    ))
)
# }}}

# {{{ SSL
ssl.engine = "enable"
ssl.pemfile = "/etc/lighttpd/server.pem"

#$SERVER["socket"] == ":80" {
#   ssl.engine = "disable"
#}

$SERVER["socket"] == ":80" {
    # capture vhost name with regex conditiona -> %0 in redirect pattern
    # must be the most inner block to the redirect rule
    $HTTP["host"] =~ ".*" {
        url.redirect = (".*" => "https://%0$0")
    }
}
# }}}

# {{{ Authentication
auth.backend = "htdigest"
auth.backend.htdigest.userfile = "/etc/lighttpd/passwd"
auth.debug = 2
# }}}


$HTTP["host"] =~ "twyk\.org" {
    server.document-root = "/srv/http/blog"
}


$HTTP["host"] =~ "roundcube\.twyk\.org" {
    server.document-root    = "/usr/share/webapps/roundcubemail/"
    accesslog.filename      = "/var/log/lighttpd/roundcube.log"
}


#$HTTP["host"] =~ "leed\.twyk\.org" {
#    server.document-root    = "/usr/share/webapps/leed/"
#    accesslog.filename      = "/var/log/lighttpd/leed.twyk.org"
#}


$HTTP["host"] =~ "kriss\.twyk\.org" {
    server.document-root    = "/usr/share/webapps/kriss/"
    accesslog.filename      = "/var/log/lighttpd/kriss.twyk.org"
}


$HTTP["host"] =~ "rsslounge\.twyk\.org" {
    server.document-root    = "/usr/share/webapps/rsslounge/"
    accesslog.filename      = "/var/log/lighttpd/rsslounge.log"

    url.rewrite-once += (
        "^/favicon.ico$" => "/public/favicon.ico",
        "^/plugins/([^/]+)/(.*)$" => "/plugins/$1/public/$2",
        "^/favicons/(.*)$" => "/data/favicons/$1",
        "^/thumbnails/(.*)$" => "/data/thumbnails/$1",
        "^/javascript/(.*)$" => "/public/javascript/$1",
        "^/stylesheets/(.*)$" => "/public/stylesheets/$1",
        "^/public/" => "/$0",
        "^/(.*)" => "/index.php?mod_rewrite=1&$1"
    )
}


$HTTP["host"] =~ "hgweb\.twyk\.org" {
    server.document-root    = "/home/hg-public/"
    accesslog.filename      = "/var/log/lighttpd/hgweb.twyk.org.log"
    cgi.assign              = (".cgi" => "/usr/bin/python2")
    server.indexfiles       = ("hgweb.cgi")
    url.rewrite-once = (
        "^/(.*)$" => "/hgweb.cgi/$1",
    )
}


$HTTP["host"] =~ "mpd\.twyk\.org" {
    proxy.server        = ("" => ("localhost" => ("host" => "127.0.0.1", "port" => 8080)))
    accesslog.filename  = "/var/log/lighttpd/mpd.log"
}


$HTTP["host"] =~ "shaarli\.twyk\.org" {
    server.document-root    = "/usr/share/webapps/shaarli/"
    accesslog.filename      = "/var/log/lighttpd/shaarli.twyk.org"
}


$HTTP["host"] =~ "zerobin\.twyk\.org" {
    server.document-root = "/usr/share/webapps/zerobin/"
    accesslog.filename   = "/var/log/lighttpd/zerobin.twyk.org"
}
